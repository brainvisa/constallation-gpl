<?xml version="1.0" encoding="utf-8" ?>
<minf version="1.0">

<xhtml name="en">
  <h1>Constellation <img align="right" src="bvimage://constellation/constellation.png" width="256" /></h1>
  
  <p><a>CONnectivity-based STructural parcELLATION</a></p>
  
  <h2>Presentation</h2>
  
  <p>The toolbox Constellation proposes a connectivity-based parcellation framework for the whole cortical surface. The approach chosen performs gyrus by gyrus to parcellate the whole human cortex. The main originality of the method is to compress for each gyrus the connectivity profiles used for the clustering without any anatomical prior information. This step takes into account the interindividual cortical and connectivity variability. To this
end, we consider intersubject high density connectivity areas extracted using a surface-based watershed algorithm.

  <b>Methods are organized as follow:</b><br/>
  
  <img src="bvimage://constellation/schema_avg.png" ALT="" height="400" width="900"/><br/>
  <img src="bvimage://constellation/schema_concat.png" ALT="" height="400" width="900"/>

  </p>

  <h2>How to use it</h2>

  <p>There are basically two diffent ways to use Constellation:
    <ul>
      <li><a href="#group_pipelines">Perform a complete group parcellation</a>.
      </li>
      <li><a href="#using_atlas">Use a predefined reference group parcellation</a> and connectivity profile to parcellate a new subject (or a new set of subjects). This mode is ligher than the complete group parcellation.
      </li>
    </ul>
  </p>

  <p>Constellation is a somewhat complex toolbox in the meaning that it is using different types of data (namely diffusion MRI and anatomical MRI), each preprocessed in potentially different ways by different software. Moreover Constellation includes both intra and inter-subject processings which are at some point intricated. A few choices have to be done by the user.
  </p>

  <p>For this reason, users are advised to read the present documentation before processing.
  </p>

  <h3>Prerequisites</h3>

  To use Constellation, some data and software are required:
  <ul>
    <li>Data: the subjects to be processed must have a T1 weighted MRI needed to segment the cortex.
    </li>
    <li>Data: the subjects to be processed must have diffusion MRI (dMRI) images with a "sufficient" quality in order to have somewhat reliable tractography.
    </li>
    <li>Data: there must be some spatial transformation information between the dMRI data and the T1 MRI, or some registration should have been applied.
    </li>
    <li>Software: <a href="https://surfer.nmr.mgh.harvard.edu/">FreeSurfer</a> is needed, at least at the moment, to segment the cortex and make meshes with inter-subject point-to-point correspondance. An alternative based on Hip Hop, in the BrainVISA toolbox Cortical Surface, is in the way.
    </li>
    <li>Software: A tractography software is needed to process the dMRI data. Currently Constellation is able to use results from the following software:
      <ul>
        <li>Connectomist 2 for the happy few who can use it
        </li>
        <li><a href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki">FSL</a>
        </li>
      </ul>
      It should be possible to use some other software (DiPy, Trackviz, MRtrix...) as long as fiber tracts or connectivity matrices formats can be read or converted. The Trackviz format (.trk) is supported and is a convenient way to import tracts. However all these software have not been validated yet for Constellation, and there will probably some additional work to be done to handle not only file formats, but also spatial transformations, and maybe adapt e few parameters.
    </li>
  </ul>

  <h3>Preprocessings</h3>

  <p>Constellation does not handle by itself the use of thirdparty software to process T1 and diffusion MRI data. The user has thus to take care of running Freesurfer on the T1 MRI (either directly or via the BrainVisa toolbox for Freesurfer), and to process the diffusion MRI and run the fiber tracking or connectivity algorithms (using Connectomist or FSL).
  </p>

  <h4>Preprocessing choices</h4>

  <h5>T1 MRI brain mesh resolution and building method</h5>

  <p>Currently T1 MRI have to be processed using FreeSurfer to take advantage of its surface-based inter-subject correspondance. Doing this an important choice have to be made: the <b>Cortical Grey/white interface mesh resolution and method.</b></p>


  <h4>Freesurfer conversions and group mesh / texture</h4>

  Once Freesurfer has run, there are two final passes that should be run on its outputs. This step features an important choice: the <b>Cortical Grey/white interface mesh resolution and method</b> (<a href="#mesh_resampling">see below</a>).

  <ul>
    <li>
      <p>Make meshes of the grey/white interfaces with vertex-vertex correspondance between subjects, and corresponding gyri textures for these meshes. The simplest way to do so is to use the BrainVisa Freesurfer toolbox and its <a href="bvprocess://freesurferToBrainvisaConversionPipeline">Freesurfer outputs To BrainVisa conversion pipeline</a>.
      </p>
      <p>The toolbox will resample on a template spherical mesh, which is not necessarily Freesurfer's one, so according to the chosen template mesh, it can end up with a different inter-subject correspondance (and a different number of vertices in meshes) than the <tt>mri_surf2surf</tt> tool from FS.
      </p>
      <p>The pipeline will also produce concatenated, whole brain (both hemispheres) meshes and textures for use with Constellation.
      </p>
      <p>These operations could also partly be done using Freesurfer <tt>mris_convert</tt> and <tt>mri_surf2surf</tt> commands to produce GIFTI files and resampled meshes but there would still be coordinates systems issues.
      </p>
    </li>
    <li>Make a group mesh and gyri texture, using the BrainVISA process from the Freesurfer toolbox <a href="bvprocess://freesurfer_average_brain_pipeline">FreeSurfer Average Brain Pipeline</a>.
    </li>
  </ul>

  <div style="background-color: #ffe0e0; padding: 10px; border: 1px solid;">
    <div style="font-weight: bold"><a name="mesh_resampling">Important: Details about meshes resampling</a></div>

    <p>Meshes must be resampled to a common resolution which provides vertex-by-vertex correspondance between subjects. To do so we use the spheric interpolation and the topology of an icosahedron-based template mesh. This can be done either using BrainVisa/Freesurfer toolbox which provides its own template icosphere mesh and interpolation method, or using FreeSurfer, which allows to resample to several icospheres with different resolutions. The choice of the template mesh is very important, because it will determine the corresponance between subjects in the group to be processed. But more importantly, using an atlas to parcellate a new subject will need to use the same template mesh as the atlas.</p>
    <p>Constellation has been tested using meshed of 30000-40000 vertices per hemisphere. Using lower resolutions will make results more imprecise, and higher resolutions will lead to more resource consuming processing. The atlas shipped with Constellation is based on meshes of 32492 vertices per hemisphere, the ones used for the Human Connectome Project (HCP) preprocessings.
    </p>

    <p>Thus in summary we have 3 different template meshes and resampling methods for it:
      <ul>
        <li>BrainVISA/Freesurfer toolbox sphere: 40962 vertices / hemisphere.</li>
        <li>Freesurfer <tt>mri_surf2surf</tt>: generally 40962 vertices / hemisphere, but several choices are possible within Freesurfer. Be careful even with the same number of vertices, the template meshes are not the same as those from the BrainVISA/Freesurfer method.
        </li>
        <li>HCP 32k mesh (32492 vertices)
        </li>
      </ul>
      All can be performed using the BrainVISA/Freesurfer toolbox, by running the  <a href="bvprocess://freesurferToBrainvisaConversionPipeline">Freesurfer outputs To BrainVisa conversion pipeline</a>, and selecting the appropriate <tt>icosphere_type</tt> template parameter (the toolbox provides 32k and 40k template meshes from Freesurfer and from the HCP). However Freesurfer native  method can also be run using the <a href="bvprocess://freesurfer_resample_mesh_to_freesurfer_ico">Resample mesh to Freesurfer Ico mesh</a> process and the command <tt>mri_surf2surf</tt> to resample textures, and the HCP method can also be used natively using the HCP workbench.
    </p>
  </div>

  <p>Constellation starts once these preprocessings have been achieved.
  </p>

  <h3>Constellation processing</h3>

  <a id="group_pipelines">
    <h4>Building group parcellations</h4></a>

  <p>In this situation, we want to build a new group-based parcellation on a given group of subjects, not using predefined atlases.
  </p>

  <p>There is some intra-subject processing, and an inter-subject (group) clustering. They correspond to two different pipelines, the intra-subject one should be used before the inter-subject part.
  </p>

  <p>Depending on the dMRI tractography software used for input to Constellation, there are different ways to handle them. Consequently there are currently 2 intra-subject piplines in Constellation, one dealing with Connectomist tracts, the other with FSL connectivity matrices. They differ on the first steps, and then have common later steps.
  </p>

  <p>
    <ul>
      <li>Intra-subject processing:
        <ul>
          <li><a href="bvprocess://constel_individual_pipeline">Connectomist-based intra-subject pipeline</a>
          </li>
          <li><a href="bvprocess://constel_individual_pipeline_fsl_connectome">FSL-based intra-subject pipeline</a>
          </li>
        </ul>
      </li>
      <li><a href="bvprocess://constel_group_pipeline">Group-based parcellation pipeline</a>
      </li>
    </ul>
  </p>

  <p>Group clusterings and assiociated connectivity profiles can then be used to make a new group atlas for instance. Group or individual connectivity profiles obtained on the clusters can be used to build and study connectivity graphs...
  </p>

  <a id="using_atlas">
    <h4>Parcellating using predefined atlases</h4></a>

  <p>This is the simplest and lightest way to work: you come with one or several subjects data, and get a parcellation for them, with labels compatible with the atlas.
  </p>

  <p>There are also two steps: one is to run the intra-subject pipeline above to get individuel connectivity matrices, then use the following process:
  </p>

  <p>
    <ul>
      <li>Intra-subject processing:
        <ul>
          <li><a href="bvprocess://constel_individual_pipeline">Connectomist-based intra-subject pipeline</a>
          </li>
          <li><a href="bvprocess://constel_individual_pipeline_fsl_connectome">FSL-based intra-subject pipeline</a>
          </li>
        </ul>
      </li>
      <li><a href="bvprocess://constel_indiv_clusters_from_atlas">Individual clusters from atlas</a>
      </li>
    </ul>
  </p>

  <h3>Other tools</h3>

  <p>Constellation clusters, or other surface-based regions actually, can be used to reduce connectivity information into a region-based connectivity matrix:
  </p>
  <p><a href="bvprocess://constel_connectome_reduced">Write the connectome of a given parcellation</a>
  </p>

</xhtml>
</minf>
